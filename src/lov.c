#include <gpiod.h>
#include <stdio.h>
#include <unistd.h>
#include "../inc/blink_led.h"

int main() {
    struct gpiod_chip *chip;
    struct gpiod_line *lines[14];
	struct gpiod_line *clk_line;
    int incr, ret;

	int lov[][22] = {
    {0, 300, 1000, 400, 1000, 400, 900, 600, 900, 600, 800, 800, 700, 600, 600, 666, 0, 0, 0, 0, 0, 0},
    {10, 229, 1000, 400, 1000, 400, 900, 600, 900, 600, 800, 800, 700, 763, 681, 666, 0, 0, 0, 0, 0, 0},
    {20, 200, 874, 200, 1000, 400, 1000, 400, 900, 600, 900, 600, 800, 705, 747, 666, 0, 0, 0, 0, 0, 0},
    {30, 184, 800, 200, 800, 200, 1000, 400, 1000, 400, 900, 600, 900, 624, 787, 666, 0, 0, 0, 0, 0, 0},
    {40, 132, 800, 200, 800, 200, 1000, 400, 1000, 400, 900, 600, 900, 600, 851, 666, 0, 0, 0, 0, 0, 0},
    {50, 61, 800, 200, 800, 200, 1000, 400, 1000, 400, 900, 551, 900, 666, 0, 0, 0, 0, 0, 0, 0, 0},
    {60, 0, 773, 0, 800, 200, 800, 200, 1000, 400, 1000, 400, 900, 473, 900, 666, 0, 0, 0, 0, 0, 0},
    {70, 0, 709, 0, 800, 200, 800, 200, 1000, 400, 1000, 400, 900, 409, 900, 666, 0, 0, 0, 0, 0, 0},
    {80, 0, 652, 0, 800, 200, 800, 200, 1000, 370, 1000, 666, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0},
    {90, 0, 600, 0, 800, 200, 800, 200, 1000, 300, 1000, 666, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0},
    {100, 0, 547, 0, 800, 200, 800, 200, 1000, 229, 1000, 666, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0},
    {110, 0, 490, 0, 800, 200, 800, 200, 874, 666, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0},
    {120, 0, 426, 0, 800, 184, 800, 666, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0},
    {130, 0, 348, 0, 800, 132, 800, 666, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0},
    {140, 0, 242, 0, 800, 61, 800, 666, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0},
    {150, 43, 156, 0, 200, 0, 773, 666, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0},
    {160, 113, 86, 0, 200, 0, 709, 666, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0},
    {170, 195, 4, 0, 200, 0, 652, 666, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0},
    {180, 300, 0, 200, 0, 0, 600, 666, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0},
    {190, 400, 32, 400, 0, 200, 0, 0, 547, 666, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0},
    {200, 409, 300, 400, 300, 400, 0, 200, 0, 0, 490, 666, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0},
    {210, 473, 300, 400, 300, 400, 0, 200, 0, 0, 426, 666, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0},
    {220, 551, 300, 400, 300, 400, 0, 200, 0, 0, 348, 666, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0},
    {230, 600, 348, 600, 300, 400, 300, 400, 0, 200, 0, 0, 242, 666, 0, 0, 0, 0, 0, 0, 0, 0},
    {240, 600, 426, 600, 300, 400, 300, 400, 0, 200, 43, 666, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0},
    {250, 600, 490, 600, 300, 400, 300, 400, 0, 200, 113, 666, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0},
    {260, 600, 547, 600, 300, 400, 300, 400, 0, 200, 195, 666, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0},
    {270, 600, 600, 600, 300, 400, 300, 400, 0, 300, 0, 666, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0},
    {280, 763, 681, 600, 600, 600, 300, 400, 300, 400, 32, 666, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0},
   {290, 705, 747, 800, 700, 600, 600, 600, 300, 409, 300, 666, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0},
    {300, 624, 787, 800, 700, 600, 600, 600, 300, 473, 300, 666, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0},
    {310, 600, 851, 600, 800, 800, 700, 600, 600, 551, 300, 666, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0},
    {320, 551, 900, 600, 900, 600, 800, 800, 700, 600, 600, 666, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0},
    {330, 473, 900, 600, 900, 600, 800, 800, 700, 600, 600, 666, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0},
    {340, 409, 900, 600, 900, 600, 800, 800, 700, 600, 600, 666, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0},
    {350, 370, 1000, 400, 1000, 400, 900, 600, 900, 600, 800, 666, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0},
    {360, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 666, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0} };


	// Open the chip 
    chip = gpiod_chip_open_by_name(GPIO_CHIP);
    if (!chip) {
        perror("gpiod_chip_open failed");
        return -1;
    }

	// Open all of the lines
	for (int i = 0; i < 14; i++) {
		lines[i] = gpiod_chip_get_line(chip, i);
		if (!lines[i]) {
			perror("gpiod_chip_get_line failed");
			gpiod_chip_close(chip);
			return -1;
		}
	}

	clk_line = gpiod_chip_get_line(chip, 26);
	if (!clk_line) {
		perror("gpiod_chip_get_line failed");
		gpiod_chip_close(chip);
		return -1;
	}


	// Lock all of the lines to the program and assign them as the correct IO
	for (int i = 0; i < 14; i++) {
		ret = gpiod_line_request_output(lines[i], "led_shift", 0);
		if (ret < 0) {
			perror("gpiod_line_request_output failed");
			for (int j = 0; j < 14; j++) {
				gpiod_line_release(lines[j]);
			}
			gpiod_chip_close(chip);
			return -1;
		}
	}
	
	ret = gpiod_line_request_output(clk_line, "led_shift", 0);
	if (ret < 0) {
		perror("gpiod_line_request_input failed");
		for (int j = 0; j < 14; j++) {
			gpiod_line_release(lines[j]);
		}
		gpiod_line_release(clk_line);
		gpiod_chip_close(chip);
		return -1;
	}
	

	// Run the loop
	while(1) {
		usleep(BLINK_DELAY);
		gpiod_line_set_value(clk_line, 0);

		usleep(BLINK_DELAY);
		gpiod_line_set_value(clk_line, 1);
	
		for (int i = 0; i < 14; i++) {
			gpiod_line_set_value(lines[i], 0);
		}
		gpiod_line_set_value(lines[incr], 1);

		incr = incr + 1;
		if (incr > 13) {
			incr = 0;
		}
	}


	for (int j = 0; j < 14; j++) {
		gpiod_line_release(lines[j]);
	}
	gpiod_line_release(clk_line);
    gpiod_chip_close(chip);

    return 0;
}
